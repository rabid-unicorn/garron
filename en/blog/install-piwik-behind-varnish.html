<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- SEO includes -->
        
<link href="/en/atom.xml" rel="alternate" title="Guillermo Garron" type="application/atom+xml" />


        <link rel="canonical" href="http://www.garron.me/en/blog/install-piwik-behind-varnish.html" />
        
<meta name="robots" content="noodp, noydir" />


<meta name="description" content="How to configure Piwik and varnish. In a way that piwik logs the real visitor IP instead of 127.0.0.1 or varnish IP " />

        <!-- End SEO includes -->
        <title>Install and configure Piwik behind Varnish reverse proxy</title>
        <!-- <link rel="stylesheet" href="/foundation/css/foundation.css" /> -->
        <link rel="stylesheet" href="//cdn.jsdelivr.net/foundation/5.5.1/css/foundation.min.css" />
        <link rel="stylesheet" href="/foundation/css/app.css">
        <link href='http://fonts.googleapis.com/css?family=Josefin+Slab|Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="/webfonts/ss-social-circle.css" type="text/css">
        <!-- <link href="/bootstrap/css/magnific-popup.css" rel="stylesheet"> -->
        <link href="//cdn.jsdelivr.net/jquery.magnific-popup/1.0.0/magnific-popup.css" rel="stylesheet">
        <!-- Twitter cards -->
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@ggarron">
        <meta name="twitter:creator" content="@ggarron">
        <meta name="twitter:title" content="Install and configure Piwik behind Varnish reverse proxy">
        <meta name="twitter:description" content="How to configure Piwik and varnish. In a way that piwik logs the real visitor IP instead of 127.0.0.1 or varnish IP">
        <!-- End Twitter Cards -->
        <!-- FB property -->
        <meta property="fb:admins" content="613797474" />
        <!-- End FB Property -->
        <!-- <script src="/foundation/js/vendor/modernizr.js"></script> -->
        <script src="//cdn.jsdelivr.net/foundation/5.5.1/js/vendor/modernizr.js"></script>
    </head>
    <body>
        
        
        <div class="row">
    <div class="contain-to-grid sticky"> 
        <nav class="top-bar" data-topbar role="navigation" data-options="sticky_on: large">
            <ul class="title-area">
                <li class="name">
                    <h1><a href="/en/">Home</a></h1>
                </li>
                <li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
            </ul>
            <section class="top-bar-section">
                <ul class="left">
                    <li><a href="/en/linux/">Linux</a></li>
                    <li><a href="/en/mac/">Mac</a></li>
                    <li><a href="/en/bits/">Tips</a></li>
                    <li><a href="/en/tech/">Tech</a></li>
                    <li><a href="/en/articles/">Articles</a></li>
                    <li><a href="/en/blog/">Blog</a></li>
                    <li><a href="/en/food/">Food</a></li>
                    <li><a href="/en/pictures/">Photos</a></li>
                    <li><a href="/en/projects/">Projects</a></li>
                    <li><a href="/en/web-design/">Web Designg</a></li>
                </ul>
            </section>
        </nav> 
    </div>
</div>
<div class="row">
    <div class="large-12 columns">
        <hr>
        <p>Get updates via: <a href="/en/atom.xml" class="ss-icon ss-social-circle">rss</a> | <a href="http://twitter.com/ggarron" class="ss-icon ss-social-circle">twitter</a> | <a href="http://feedburner.google.com/fb/a/mailverify?uri=GuillermoGarronMainSite&amp;loc=en_US" class="ss-icon ss-social-circle">email</a> | <a href="https://plus.google.com/u/0/115745027821234071812" class="ss-icon ss-social-circle">google+</a></p>
        <ul class="breadcrumbs">
            
            <li><a href="/index.html">Geeking</a>
            <li class="divider">&gt;</li>
            
            <li><a href="/en/index.html">Tech Blog</a>
            <li class="divider">&gt;</li>
            
            <li><a href="/en/blog/index.html">Personal</a>
            <li class="divider">&gt;</li>
            
            <li class="active">Install and configure Piwik behind Varnish reverse proxy</li>
        </ul>
    </div>
</div>
<div class="row">
    <div class="small-12 large-9 large-centered medium-9 medium-centered columns">
        <h3><a href="/en/blog/install-piwik-behind-varnish.html">Install and configure Piwik behind Varnish reverse proxy</a></h3>
<h6>Written by <a href="/en/about.html">Guillermo Garron</a> .</h6>
<h6>Date: 2013-01-13 13:14:00 -0500</h6>

<hr>
<p>Piwik is a good replacement for Google Analytics, and good options for you if you do not want to use cookies for your analytics solution. With it you can <a href="/en/blog/analytics-web-stats-without-google-cookies.html">run analytics without cookies</a></p>

<p>If you install it behind a reverse proxy you can face some issues, it is supposed to automatically detect the reverse proxy, and configured itself to work with it. Here some guidelines if that simply does not happen.</p>

<h2 id="installing-and-configuring-piwik-behind-varnish">Installing and configuring Piwik behind Varnish</h2>

<p>Varnish is one of the most efficient reverse proxy servers available today, it makes your slow sites just fly, but it also creates some issues when you are running a complete dynamic site behind it. Piwik is 100% dynamic, so it is better to not cache it. Here what you need to do:</p>

<p><strong>Varnish</strong></p>

<p>You need to edit the varnish vcl, which may be named default.vcl</p>

<p>Add these lines in <em>vcl_recv</em></p>

<pre><code>if (req.http.host == "piwik.domain.com") {
	set req.http.X-Forwarded-For = client.ip;
	return(pass);
}
</code></pre>

<p>This will tell Varnish two things, first to send Piwik the IP of the customer in the X-Forward-For http header and to directly look at the back end server (Apache in my case, but Nginx will work just the same)</p>

<p>The first order will avoid Piwik from showing like all visits come from the Varnish’ IP, usually 127.0.0.1, and show the real visitor’s IP. The second will avoid Varnish to look for the reply in the Cache.</p>

<p>In the <em>vcl_fetch</em> add this:</p>

<pre><code>if (req.http.host == "piwik.domain.com") {
	return(hit_for_pass);
}
</code></pre>

<p>This will tell Varnish not to cache any reply that comes from the back end when the requested url is in the <em>piwik.domain.com</em>. I am assuming you are installing piwik in that domain, use the domain where you have installed Piwik instead of that.</p>

<p><strong>Piwik</strong></p>

<p>You also need to edit the Piwik configuration file: <em>config/config.ini.php</em> which is inside your Piwik installation folder and add those lines, if the [General] section already exists, just add the last to lines to that section.</p>

<pre><code>[General]
proxy_client_headers[] = "HTTP_X_FORWARDED_FOR"
proxy_host_headers[] = "HTTP_X_FORWARDED_FOR
</code></pre>

<p>You should be OK with that, and Piwik should be working behind a proxy, Varnish in this case.</p>


<hr>
<a href="http://www.garron.me/en/blog/install-piwik-behind-varnish.html">permalink</a>
<hr>
<p>If you enjoyed the article, please share it</a>
<p><a class="ss-icon ss-social-circle" href="http://twitter.com/intent/tweet?url=http://www.garron.me/en/blog/install-piwik-behind-varnish.html&text=Install and configure Piwik behind Varnish reverse proxy&via=ggarron">twitter</a> | <a class="ss-icon ss-social-circle" href="http://facebook.com/sharer.php?u=http://www.garron.me/en/blog/install-piwik-behind-varnish.html">facebook</a> | <a class="ss-icon ss-social-circle" href="https://plus.google.com/share?url=http%3A%2F%2Fwww.garron.me/en/blog/install-piwik-behind-varnish.html">google+</a> | <a class="ss-icon ss-social-circle" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fwww.garron.me/en/blog/install-piwik-behind-varnish.html">linkedin</a> | <a href="mailto:?Subject=Install and configure Piwik behind Varnish reverse proxy&Body=http://www.garron.me/en/blog/install-piwik-behind-varnish.html" class="ss-icon ss-social-circle">email</a> | <a href="http://reddit.com/submit?url=http://www.garron.me/en/blog/install-piwik-behind-varnish.html&title=Install and configure Piwik behind Varnish reverse proxy" class="ss-icon ss-social-circle">reddit</a></p>

<hr>
<!-- <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'garronblog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> -->


    </div>
</div>
      
        <!-- jQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <!-- <script src="/foundation/js/vendor/jquery.js"></script> -->
        <!-- <script src="/foundation/js/foundation.min.js"></script> -->
        <script src="//cdn.jsdelivr.net/foundation/5.5.1/js/foundation.min.js"></script>
        <!-- <script src="/foundation/js/rainbow.min.js"></script> -->
        <script src="//cdn.jsdelivr.net/rainbow/1.1.9/rainbow.min.js"></script>
        <!-- <script src="/bootstrap/js/magnific-popup.js"></script> -->
        <script src="//cdn.jsdelivr.net/jquery.magnific-popup/1.0.0/jquery.magnific-popup.min.js"></script>
        <!-- To start magnific popup -->
        <script src="/bootstrap/js/custom.js"></script>
        <script>
          $(document).foundation();
        </script>
        <!-- Analytics -->
        <!-- <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-1514170-11']);
  _gaq.push(['_setDomainName', 'www.garron.me']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>    -->
        <!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//piwik.go2linux.com/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 1]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src='http://d2lx14ao1t3d4g.cloudfront.net/piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//piwik.go2linux.com/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->



        <!-- end analytics -->
    </body>
</html>
